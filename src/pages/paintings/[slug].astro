---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getImage } from "astro:assets";
import { paintings } from "../../lib/paintings";
import captions from "../../data/paintings.captions.json";


export async function getStaticPaths() {
  return paintings.map((p) => ({
    params: { slug: p.slug },
  }));
}

const { slug } = Astro.params;
const meta = captions[slug];
const idx = paintings.findIndex((p) => p.slug === slug);
if (idx < 0) throw new Error(`Photo not found: ${slug}`);

const painting = paintings[idx];
const prev = idx > 0 ? paintings[idx - 1] : null;
const next = idx < paintings.length - 1 ? paintings[idx + 1] : null;

// Generate a display-optimized â€œfullâ€ image at build time.
// You can bump width to 3200 if you want.
const full = await getImage({
  src: painting.image,
  width: 2600,
  format: "webp",
  quality: 90,
});
---

<BaseLayout title={`${painting.slug} Â· Paintings Â· jonesyco`}>
  <div class="wrap">
    <header class="photoTop">
      <a class="pill" href="/paintings">â† Paintings</a>
      <div class="photoNav">
        {prev ? <a class="pill" href={`/paintings/${prev.slug}`} rel="prev">â† Prev</a> : <span class="pill disabled">â† Prev</span>}
        {next ? <a class="pill" href={`/paintings/${next.slug}`} rel="next">Next â†’</a> : <span class="pill disabled">Next â†’</span>}
      </div>
    </header>

  <div class="photoStage">
  <div class="photoViewer">
    <img
    id="photoMain"
      src={full.src}
      width={full.attributes.width}
      height={full.attributes.height}
      alt={painting.slug}
      loading="eager"
      decoding="async"
    />
  </div>

  <section id="photoInfo" class="photoInfo card">
  <div class="photoInfoRow">
  <div class="photoInfoMain">
  <h1 class="photoTitle">{meta?.title ?? painting.slug}</h1>

  {meta?.caption && (
    <p class="photoCaption">{meta.caption}</p>
    )}
 </div>
 
 

 {(meta?.location || meta?.date) && (
    <div class="photoMeta">
      {meta?.location && <span class="badge">ğŸ“ {meta.location}</span>}
      {meta?.date && <span class="badge">ğŸ—“ {meta.date}</span>}
    </div>
  )}
  </div>
    <p class="photoHint">
    Use <strong>â†</strong> / <strong>â†’</strong> keys to navigate. Press <strong>Esc</strong> to return to the gallery.
  </p>
</section>
</div>
</div>
  

  <script>
   (() => {
    const goBack = () => {
      // Always return to gallery
      window.location.href = "/paintings";
    };

    const onKey = (e) => {
      // Ignore typing inside inputs (future-proofing)
      const tag = document.activeElement?.tagName;
      if (tag === "INPUT" || tag === "TEXTAREA") return;

      if (e.key === "Escape") {
        e.preventDefault();
        goBack();
      }

      if (e.key === "ArrowLeft") {
        const prev = document.querySelector('a[rel="prev"]');
        if (prev) prev.click();
      }

      if (e.key === "ArrowRight") {
        const next = document.querySelector('a[rel="next"]');
        if (next) next.click();
      }
    };

    // Use capture phase so nothing blocks it
    window.addEventListener("keydown", onKey, { capture: true });
  })();

     (function () {
    const img = document.getElementById("photoMain");
    const info = document.getElementById("photoInfo");
    if (!img || !info) return;

    const setWidth = () => {
      const w = img.getBoundingClientRect().width;
      // Guard against 0 width during initial layout
      if (w > 10) info.style.width = `${w}px`;
    };

    // Run after image is laid out
    if (img.complete) setWidth();
    else img.addEventListener("load", setWidth, { once: true });

    // Keep in sync on resize/orientation changes
    window.addEventListener("resize", setWidth);

    // If fonts load late and reflow text, resync once more
    if (document.fonts?.ready) document.fonts.ready.then(setWidth);
  })();
  </script>

 
</BaseLayout>